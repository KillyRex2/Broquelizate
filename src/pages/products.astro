---
import { ProductList } from "@/components";
import { FilterSidebar } from "@/components/products/FilterSidebar";
import Pagination from "@/components/shared/Pagination.astro";
import ProductsLayout from "@/layouts/ProductsLayout.astro";
import { actions } from "astro:actions";

const searchParams = Astro.url.searchParams;

// Obtener todos los parámetros de filtrado de la URL
const pageParam = Number(searchParams.get('page') || 1);
const categoryParam = searchParams.get('category') || 'all';
const maxPriceParam = Number(searchParams.get('maxPrice')) || 5000;
const inStockParam = searchParams.get('inStock') === 'true';
const search = searchParams.get('search') || '';

// Llamar a la acción con todos los parámetros
const { data, error } = await Astro.callAction(
  actions.getProductsByPage,  
  {
    page: pageParam,
    category: categoryParam,
    maxPrice: maxPriceParam,
    inStock: inStockParam,
    search: search,
  }
);

// Manejo de errores
if (error) {
  console.error("Error al cargar productos:", error);
  return Astro.redirect('/error');
}

const { products, totalPages } = data;

// Redirigir si no hay productos en la página actual
if (products.length === 0 && totalPages > 0) {
  // Mantener los parámetros de filtro en la redirección
  const queryParams = new URLSearchParams({
    page: totalPages.toString(),
    category: categoryParam,
    maxPrice: maxPriceParam.toString(),
    inStock: inStockParam.toString(),
    search: search.toString()
  });
  
  return Astro.redirect(`/products?${queryParams.toString()}`);
}

// Preparar datos para pasar al componente FilterSidebar
const filterState = {
  selectedCat: categoryParam,
  price: maxPriceParam,
  inStock: inStockParam,
  search: search  // ¡Asegúrate de incluir este campo!
};
---

<ProductsLayout>
  <div class="grid grid-cols-1 md:grid-cols-[250px_1fr] gap-6">
    <!-- Sidebar -->
    <FilterSidebar 
      client:load
      initialValues={filterState}
    />

    <!-- Productos -->
    <div class="flex flex-col gap-4">
      <ProductList products={products} client:load />

      <!-- Paginación al final de los productos -->
      <Pagination 
        totalPages={totalPages} 
        currentPage={pageParam} 
        queryParams={{
          category: categoryParam,
          maxPrice: maxPriceParam,
          inStock: inStockParam,
          search: search  // Añade esto también
        }}
      />
    </div>
  </div>
</ProductsLayout>