---
// src/pages/login.astro
import AuthLayout from "@/layouts/AuthLayout.astro";

const email = Astro.cookies.get("email")?.value ?? "";
const rememberMe = !!email;
---

<AuthLayout>
  <div class="flex justify-center self-center z-10">
    <div class="p-12 bg-white mx-auto rounded-2xl w-full max-w-md shadow-lg">
      <div class="text-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Iniciar sesión</h2>
        <p class="mt-1 text-gray-600">Ingresa tus credenciales para continuar</p>
      </div>
      
      <!-- Botón de Google -->
      <div class="space-y-4">
        <button id="google-signin-btn" class="w-full inline-flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition">
          <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48">
            <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path>
            <path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path>
            <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.226-11.283-7.662l-6.522 5.025A20.02 20.02 0 0 0 24 44z"></path>
            <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.018 35.24 44 30.028 44 24c0-1.341-.138-2.65-.389-3.917z"></path>
          </svg>
          <span>Iniciar sesión con Google</span>
        </button>
      </div>

      <!-- Separador -->
      <div class="my-6 flex items-center">
        <div class="flex-grow border-t border-gray-300"></div>
        <span class="flex-shrink mx-4 text-sm text-gray-500">o continúa con</span>
        <div class="flex-grow border-t border-gray-300"></div>
      </div>

      <!-- Formulario de Email/Contraseña -->
      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="email" name="email" type="email" value={email} required class="mt-1 w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition" placeholder="tu@email.com" />
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
          <input id="password" name="password" type="password" required class="mt-1 w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition" placeholder="Tu contraseña" />
        </div>
        <div class="flex items-center justify-between">
          <label class="flex items-center text-sm">
            <input id="remember_me" name="remember_me" type="checkbox" checked={rememberMe} class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-300 rounded" />
            <span class="ml-2 text-gray-700">Recordarme</span>
          </label>
          <a href="#" class="text-sm text-yellow-500 hover:underline">¿Olvidaste tu contraseña?</a>
        </div>
        <button id="btn-login" type="submit" class="w-full py-3 font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition">
          <span id="btn-text">Iniciar sesión</span>
        </button>
      </form>

      <p class="mt-6 text-center text-sm text-gray-600">
        ¿No tienes una cuenta? <a href="/register" class="text-yellow-500 font-semibold hover:underline">Regístrate</a>
      </p>
    </div>
  </div>
</AuthLayout>

<script>
  import { navigate } from "astro:transitions/client";
  import Swal from "sweetalert2";
  import { signIn } from "auth-astro/client";

  function setupLoginPage() {
    const form = document.getElementById('login-form') as HTMLFormElement | null;
    const btnSubmit = document.getElementById('btn-login') as HTMLButtonElement | null;
    const btnText = document.getElementById('btn-text') as HTMLSpanElement | null;
    const googleSignInBtn = document.getElementById('google-signin-btn') as HTMLButtonElement | null;
    
    if (!form || !btnSubmit || !btnText || !googleSignInBtn) return;

    googleSignInBtn.addEventListener('click', async () => {
      try {
        await signIn('google');
      } catch (error) {
        console.error("Error al iniciar sesión con Google:", error);
        Swal.fire({ icon: 'error', title: 'Error con Google', text: 'No se pudo autenticar con Google.', confirmButtonColor: '#d97706' });
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btnSubmit.disabled = true;
      btnText.textContent = 'Cargando...';

      try {
        // ✅ CORRECCIÓN: Se pasan las credenciales y las opciones en un solo objeto.
        // Se usa 'as any' para evitar un error de tipado de la librería, que espera
        // este formato en tiempo de ejecución pero no lo tiene bien definido en sus tipos.
        const response = await signIn('credentials', {
          email: form.email.value,
          password: form.password.value,
          redirect: false,
        } as any);

        if (!response?.ok) {
          throw new Error("Credenciales inválidas");
        }
        
        navigate('/');

      } catch (error) {
        Swal.fire({ icon: 'error', title: 'Error al iniciar sesión', text: 'El correo o la contraseña son incorrectos.', confirmButtonColor: '#d97706' });
      } finally {
        btnSubmit.disabled = false;
        btnText.textContent = 'Iniciar sesión';
      }
    });
  }

  document.addEventListener('astro:page-load', setupLoginPage);
</script>

<style>
  body { background-color: transparent; }
  #btn-login:disabled { opacity: 0.7; cursor: not-allowed; }
</style>
