---
// src/pages/admin/client/[id].astro
import AdminLayout from '@/layouts/AdminLayout.astro';
import { actions } from 'astro:actions';

// Obtener el ID del cliente desde la URL
const { id } = Astro.params;
if (!id) return Astro.redirect('/admin/customers');

// Llamar a la acción para obtener datos del cliente
type Client = {
  id: string;
  nombre: string;
  clave_elector?: string;
  telefono?: string;
  saldo_actual: number;
  observations?: string;
};
const { data: client, error } = await Astro.callAction(actions.getClientById, id);
if (error || !client) return Astro.redirect('/404');
---
<AdminLayout title={`Editando a ${client.nombre}`}>  
  <div class="ml-64 max-w-4xl mx-auto px-6 py-12">    
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <a href="/admin/customers" class="text-gold-500 hover:text-gold-400 transition-colors">
        &larr; Volver a Clientes
      </a>
      <h1 class="text-5xl font-extrabold text-white tracking-tight">Editar Cliente</h1>
    </header>

    <div class="bg-gray-900/80 backdrop-blur-lg border border-gray-700 rounded-3xl p-10 shadow-2xl">
      <form id="edit-client-form" class="space-y-8">
        <input type="hidden" name="id" value={client.id} />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Izquierda -->
          <div class="space-y-6">
            <label class="block">
              <span class="text-gray-300">Nombre Completo</span>
              <input type="text" name="nombre" value={client.nombre} required
                class="mt-1 block w-full bg-gray-800 text-gray-100 border border-gray-600 rounded-lg px-4 py-2 focus:border-gold-500 focus:ring-gold-500 outline-none transition" />
            </label>

            <label class="block">
              <span class="text-gray-300">Clave de Elector</span>
              <input type="text" name="clave_elector" value={client.clave_elector ?? ''}
                class="mt-1 block w-full bg-gray-800 text-gray-100 border border-gray-600 rounded-lg px-4 py-2 focus:border-gold-500 focus:ring-gold-500 outline-none transition" />
            </label>

            <label class="block">
              <span class="text-gray-300">Teléfono</span>
              <input type="tel" name="telefono" value={client.telefono ?? ''}
                class="mt-1 block w-full bg-gray-800 text-gray-100 border border-gray-600 rounded-lg px-4 py-2 focus:border-gold-500 focus:ring-gold-500 outline-none transition" />
            </label>
          </div>

          <!-- Derecha -->
          <div class="space-y-6">
            <label class="block">
              <span class="text-gray-300">Saldo Actual</span>
              <input type="number" name="saldo_actual" step="0.01" value={client.saldo_actual} required
                class="mt-1 block w-full bg-gray-800 text-gray-100 border border-gray-600 rounded-lg px-4 py-2 focus:border-gold-500 focus:ring-gold-500 outline-none transition" />
            </label>

            <label class="block">
              <span class="text-gray-300">Observaciones</span>
              <textarea name="observaciones" rows="4"
                class="mt-1 block w-full bg-gray-800 text-gray-100 border border-gray-600 rounded-lg px-4 py-2 focus:border-gold-500 focus:ring-gold-500 outline-none transition">{client.observaciones ?? ''}</textarea>
            </label>
          </div>
        </div>

        <div class="pt-6 border-t border-gray-700 flex justify-end">
          <button type="submit"
            class="inline-flex items-center px-8 py-3 bg-gold-500 hover:bg-gold-400 text-gray-900 font-semibold rounded-full shadow-lg transform hover:scale-105 transition">
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <style>
    /* Gold color */
    .text-gold-500 { @apply text-yellow-400; }
    .hover\:text-gold-400:hover { @apply text-yellow-300; }
    .bg-gold-500 { @apply bg-yellow-400; }
    .hover\:bg-gold-400:hover { @apply bg-yellow-300; }
    .focus\:ring-gold-500:focus { @apply ring-yellow-400; }
    .focus\:border-gold-500:focus { @apply border-yellow-400; }
     .form-input { 
    @apply w-full px-4 py-3 bg-slate-50 text-slate-900 border border-slate-200 rounded-lg shadow-sm 
           focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors; 
  };
  </style>

  <script>
    import Swal from 'sweetalert2';
    import 'sweetalert2/dist/sweetalert2.min.css';
    import { navigate } from 'astro:transitions/client';
    import { actions } from 'astro:actions';

    document.addEventListener('astro:page-load', () => {
      const form = document.getElementById('edit-client-form');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
        btn.disabled = true;
        btn.textContent = 'Guardando...';

        try {
          const formData = new FormData(form as HTMLFormElement);
          const { error, data } = await actions.updateClient(formData);
          if (error) throw new Error(error.message);
          Swal.fire({
            title: '¡Cliente Actualizado!',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false,
            background: '#1f2937',
            color: '#fef3c7'
          });
          navigate('/admin/customers');
        } catch (err) {
          Swal.fire({
            title: 'Error',
            text: err instanceof Error ? err.message : 'Error desconocido',
            icon: 'error',
            background: '#1f2937',
            color: '#fef3c7'
          });
        } finally {
          btn.disabled = false;
          btn.textContent = 'Guardar Cambios';
        }
      });
    });
  </script>
</AdminLayout>
